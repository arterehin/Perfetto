/**
 * Perfetto - Pixel Perfect
 *
 * @author      Artem Terekhin
 * @version     0.0.1
 * @demo        http://www.letscode.me/perfetto/
 */

var Perfetto=new function(){this.init=function(){this.generateUI();this.getOptions();this.fillOptions();this.bind([this.c.lock],"click",this.proxy("toggleLock"));this.bind([this.c.show],"click",this.proxy("toggleShow"));this.bind([this.c.close],"click",this.proxy("toggleEntry"));this.bind([this.c.url,this.c.position.x,this.c.position.y,this.c.opacity,this.c.zIndex],"keyup",this.proxy("updateOptions"));this.bind([this.c.position.x,this.c.position.y,this.c.opacity,this.c.zIndex],"keydown",this.proxy("valueChange"));this.bind([this.c.head,this.layer],"mousedown",this.proxy("dragTo"));this.bind([this.c.head,this.layer],"dragstart",function(a){a.preventDefault()})};this.generateUI=function(){var a='<div class="pf_head" data-pf="head"><ul class="pf_layer-control"><li data-pf="show" class="pf_icon __off"></li><li data-pf="lock" class="pf_icon __unlock"></li></ul><h3 data-pf="close" class="pf_title">Perfetto</h3></div><div data-pf="entry" class="pf_entry __visible"><form action="#" class="pf_form"><fieldset class="pf_field_wrap"><div class="pf_field"><label>URL</label><input type="text" name="url"/></div></fieldset><fieldset class="pf_field_group"><div class="pf_field __first"><label>X</label><input type="text" name="pos-x"/></div><div class="pf_field"><label>Y</label><input type="text" name="pos-y"/></div></fieldset><fieldset class="pf_field_group"><div class="pf_field __first"><label>Opacity</label><input type="text" name="opacity"/></div><div class="pf_field"><label>z-Index</label><input type="text" name="zindex"/></div></fieldset></form></div>';this.pf=document.createElement("div");this.pf.className=this.o.namespaces.wrapper;this.pf.innerHTML=a;this.layer=document.createElement("div");this.layer.className=this.o.namespaces.layer;this.c={head:this.pf.querySelector('[data-pf="head"]'),show:this.pf.querySelector('[data-pf="show"]'),lock:this.pf.querySelector('[data-pf="lock"]'),close:this.pf.querySelector('[data-pf="close"]'),entry:this.pf.querySelector('[data-pf="entry"]'),url:this.pf.querySelector('[name="url"]'),position:{x:this.pf.querySelector('[name="pos-x"]'),y:this.pf.querySelector('[name="pos-y"]')},opacity:this.pf.querySelector('[name="opacity"]'),zIndex:this.pf.querySelector('[name="zindex"]')};document.body.appendChild(this.pf);document.body.appendChild(this.layer)};this.saveOptions=function(){localStorage.Perfetto=true;localStorage["Perfetto.o.position"]=this.o.position;localStorage["Perfetto.o.close"]=this.o.close;localStorage["Perfetto.o.layer.current"]=this.o.layer.current;localStorage["Perfetto.o.layer.show"]=this.o.layer.show;localStorage["Perfetto.o.layer.lock"]=this.o.layer.lock;localStorage["Perfetto.o.layer.url"]=this.o.layer.url;localStorage["Perfetto.o.layer.position"]=this.o.layer.position;localStorage["Perfetto.o.layer.opacity"]=this.o.layer.opacity;localStorage["Perfetto.o.layer.zIndex"]=this.o.layer.zIndex};this.getOptions=function(){if(localStorage.Perfetto==="true"){var b=localStorage["Perfetto.o.position"].split(",");var a=localStorage["Perfetto.o.layer.position"].split(",");this.o.position=[parseInt(b[0]),parseInt(b[1])];this.o.close=localStorage["Perfetto.o.close"]==="true";this.o.layer.current=parseInt(localStorage["Perfetto.o.layer.current"]);this.o.layer.show=localStorage["Perfetto.o.layer.show"]==="true";this.o.layer.lock=localStorage["Perfetto.o.layer.lock"]==="true";this.o.layer.url=localStorage["Perfetto.o.layer.url"];this.o.layer.position=[parseInt(a[0]),parseInt(a[1])];this.o.layer.opacity=parseFloat(localStorage["Perfetto.o.layer.opacity"]);this.o.layer.zIndex=parseInt(localStorage["Perfetto.o.layer.zIndex"])}};this.fillOptions=function(){this.pf.style.left=this.o.position[0]+"px";this.pf.style.top=this.o.position[1]+"px ";if(this.o.close){this.toggleEntryToHidden()}else{this.toggleEntryToVisible()}if(this.o.layer.show){this.toggleShowToVisible()}else{this.toggleShowToHidden()}if(this.o.layer.lock){this.toggleLockToLocked()}else{this.toggleLockToUnlocked()}this.c.url.value=this.o.layer.url;this.changeURL();this.c.position.x.value=this.o.layer.position[0];this.c.position.y.value=this.o.layer.position[1];this.changePosition();this.c.opacity.value=this.o.layer.opacity;this.changeOpacity();this.c.zIndex.value=this.o.layer.zIndex;this.changeZIndex()};this.updateOptions=function(a){switch(a.currentTarget.name){case"url":this.o.layer.url=this.c.url.value;this.changeURL();break;case"pos-x":this.o.layer.position[0]=this.c.position.x.value;this.changePosition();break;case"pos-y":this.o.layer.position[1]=this.c.position.y.value;this.changePosition();break;case"opacity":this.o.layer.opacity=this.c.opacity.value;this.changeOpacity();break;case"zindex":this.o.layer.zIndex=this.c.zIndex.value;this.changeZIndex();break}this.saveOptions()};this.valueChange=function(b){if(b.keyCode==38){if(b.currentTarget.name=="opacity"){var a=b.currentTarget.value*10+1;if(a>10){a=10}this.c.opacity.value=a/10}else{if(b.currentTarget.name=="pos-x"||b.currentTarget.name=="pos-y"){if(!this.o.layer.lock){b.currentTarget.value++}}else{b.currentTarget.value++}}}else{if(b.keyCode==40){if(b.currentTarget.name=="opacity"){var a=b.currentTarget.value*10-1;if(a<0){a=0}this.c.opacity.value=a/10}else{if(b.currentTarget.name=="pos-x"||b.currentTarget.name=="pos-y"){if(!this.o.layer.lock){b.currentTarget.value--}}else{b.currentTarget.value--}}}}};this.dragTo=function(h){var c=this;var d=h.currentTarget;if(d==this.c.head){d=this.pf}if(d.className!=c.o.namespaces.layer||(d.className==c.o.namespaces.layer&&!c.o.layer.lock)){var g=h.pageX-d.offsetLeft;var f=h.pageY-d.offsetTop;function b(j){var i=j.pageX-g;var k=j.pageY-f;d.style.left=i+"px";d.style.top=k+"px";if(d.className==c.o.namespaces.wrapper){c.o.position[0]=i;c.o.position[1]=k}if(d.className==c.o.namespaces.layer){c.c.position.x.value=c.o.layer.position[0]=i;c.c.position.y.value=c.o.layer.position[1]=k}c.saveOptions()}function a(){c.unbind([document],"mousemove",b);c.unbind([document],"mouseup",a)}c.bind([document],"mousemove",b);c.bind([document],"mouseup",a)}};this.toggleLock=function(){if(this.o.layer.lock){this.toggleLockToUnlocked();this.o.layer.lock=false}else{this.toggleLockToLocked();this.o.layer.lock=true}this.saveOptions()};this.toggleLockToLocked=function(){this.removeClass(this.c.lock,"__unlock");this.addClass(this.c.lock,"__lock")};this.toggleLockToUnlocked=function(){this.removeClass(this.c.lock,"__lock");this.addClass(this.c.lock,"__unlock")};this.toggleShow=function(){if(this.o.layer.show){this.toggleShowToHidden();this.o.layer.show=false}else{this.toggleShowToVisible();this.o.layer.show=true}this.saveOptions()};this.toggleShowToVisible=function(){this.removeClass(this.c.show,"__off");this.addClass(this.c.show,"__on");this.layer.style.display="block"};this.toggleShowToHidden=function(){this.removeClass(this.c.show,"__on");this.addClass(this.c.show,"__off");this.layer.style.display="none"};this.toggleEntry=function(){if(this.o.close){this.toggleEntryToVisible();this.o.close=false}else{this.toggleEntryToHidden();this.o.close=true}this.saveOptions()};this.toggleEntryToVisible=function(){this.addClass(this.c.entry,"__visible");this.c.entry.style.display="block"};this.toggleEntryToHidden=function(){this.removeClass(this.c.entry,"__visible");this.c.entry.style.display="none"};this.changeURL=function(){this.layer.innerHTML='<img src="'+this.o.layer.url+'"/>'};this.changePosition=function(){this.layer.style.left=this.o.layer.position[0]+"px";this.layer.style.top=this.o.layer.position[1]+"px"};this.changeOpacity=function(){this.layer.style.opacity=this.o.layer.opacity};this.changeZIndex=function(){this.layer.style.zIndex=this.o.layer.zIndex};this.hasClass=function(b,a){return new RegExp(" "+a+" ").test(" "+b.className+" ")};this.addClass=function(b,a){if(!this.hasClass(b,a)){b.className+=" "+a}};this.removeClass=function(b,a){var c=" "+b.className.replace(/[\t\r\n]/g," ")+" ";if(this.hasClass(b,a)){while(c.indexOf(" "+a+" ")>=0){c=c.replace(" "+a+" "," ")}b.className=c.replace(/^\s+|\s+$/g,"")}};this.bind=function(c,b,d){for(var a=0;a<c.length;a++){if(c[a].addEventListener){c[a].addEventListener(b,d)}else{c[a].attachEvent("on"+b,d)}}};this.unbind=function(c,b,d){for(var a=0;a<c.length;a++){if(c[a].removeEventListener){c[a].removeEventListener(b,d)}else{c[a].detachEvent("on"+b,d)}}};this.proxy=function(c,a,b){b=b||this;a=a||[];if(typeof c=="string"){c=b[c]}return function(){var d=a.slice();for(var e=0;e<arguments.length;e++){if(typeof d[e]=="undefined"||d[e]===null){d[e]=arguments[e]}}return c.apply(b,d)}};this.o={namespaces:{wrapper:"pf",layer:"pf_layer"},position:[15,15],close:false,layer:{current:0,show:true,lock:false,url:"/perfetto/layers/index.jpg",position:[0,0],opacity:0.5,zIndex:1000}};this.init()};